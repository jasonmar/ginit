# GInit

GInit stores a Google IAM Access Token in Hadoop Configuration or GCS with KMS envelope encryption and writes a Hadoop Configuration XML to configure the GCS connector to use the stored access token for user credentials.

GInit enables Hadoop applications to access Google Cloud Storage using a user identity rather than service account.


## Purpose

This project is meant to be used a starting point while preparing to deploy [GCP Token Broker](https://github.com/GoogleCloudPlatform/gcp-token-broker), which will provide Hadoop users with a seamless experience but requires additional deployment effort.


## How it works

This project provides two implementations of Hadoop AccessTokenProvider, which are used by the GCS Connector to obtain Google IAM Access Tokens for reading from and writing to GCS.

Upon running GInit, user Google IAM credentials are encrypted and stored in GCS with KMS envelope encryption or in a Hadoop Configuration XML file encrypted using an AES Key loaded from Kerberos KeyTab. GInit writes an XML for the user to submit with their application.

The configuration sets `fs.gs.auth.access.token.provider.impl` to `com.google.cloud.ginit.KrbAccessTokenProvider` or `com.google.cloud.ginit.EncryptedStorageAccessTokenProvider` to use the AccessToken Provider


### Example Hadoop Configuration generated by GInit

#### Kerberos Mode Hadoop Configuration XML

```xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<configuration>
    <property>
        <name>fs.gs.auth.krb.keyfile.ciphertext</name>
        <value>4cpYlsYPo0eNS3sbyFL7rTNhoB34bxuMplEUsbgjKs4+8E7JL6Td8hqjdcS0BoyPlL9v7pEEb............................BiDhC5U20wEdrWZBlvWZSnBOuH8I/Zk69705wTSkq9priCqyvGDVD9ubUM7bbE5I87j8VefJmwqKvJs/svC5EtOY2uQLWfukRJauar3NbrTFV2RTWisOLcGv4TQWFt5FMwbwu9gCKgJvlmFYTcR0Gvz9OE</value>
    </property>
    <property>
        <name>fs.gs.auth.access.token.provider.impl</name>
        <value>com.google.cloud.ginit.KrbAccessTokenProvider</value>
    </property>
    <property>
        <name>fs.gs.auth.krb.principal</name>
        <value>user@EXAMPLE.COM</value></property>
    <property>
        <name>fs.gs.auth.krb.keytab</name>
        <value>/path/to/user.keytab</value>
    </property>
</configuration>
```

#### KMS Mode Hadoop Configuration XML

```xml
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<configuration>
    <property>
        <name>fs.gs.auth.access.token.provider.impl</name>
        <value>com.google.cloud.ginit.EncryptedStorageAccessTokenProvider</value>
    </property>
    <property>
        <name>fs.gs.auth.access.token.uri</name>
        <value>gs://bucket/2c00624611e84dcd8460da9ff06c6917dbcb83ee2ea633e6e245b76d92dcb1b7</value>
    </property>
</configuration>
```

### Example GCS Object Metadata

`kms` metadata key

`gcp-kms`

`keyId` metadata key

`gcp-kms://projects/myproject/locations/us-east1/keyRings/keyring1/cryptoKeys/key1`

`keyset` metadata key

```json
{
  "keysetInfo": {
    "primaryKeyId": 467537515,
    "keyInfo": [
      {
        "typeUrl": "type.googleapis.com/google.crypto.tink.AesGcmHkdfStreamingKey",
        "outputPrefixType": "RAW",
        "keyId": 467537515,
        "status": "ENABLED"
      }
    ]
  },
  "encryptedKeyset": "CiQAR2lcNOwaSyn9ZmPup4RyAexZuPuzFDC4le7tfc0ticjHYRkSrAEA4UisTv2pqpxC0R8nUKx/CmLbwF..................................................AnrPFyRF1jy2rAtwX/5C9jK0b/t6qRnfEgJZWKyONa8uBlNLHdtHaEi9DXZir/JUJXTFvVywgJ9RaBFooVYuXmn+WD3czLhShHKJ7hQCdstVH59VhqBw7v+EEwgPImfsBc12ZzX6uwLTfJtcKe1ShliHMN"
}
```


## Usage

GInit has two modes, Kerberos and KMS.


### Kerberos Mode

`java -jar ginit.jar krb principal keyTabPath remoteKeyTabPath`


### KMS Mode

`java -jar ginit.jar kms tokenBucket kmsKeyId project`


### Example Help Text

```
GInit 0.1.0
Usage: GInit [krb|kms] [options] <args>...

  confFile                 Hadoop Configuration XML file (default: ginit.xml)
  readOnly                 Create access token with 'devstorage.read_only' storage scope (default: false)
  refreshToken             Store refresh token (default: false)
Command: krb principal keyTabPath

  principal                Kerberos Principal 'user@EXAMPLE.COM' or 'service/HOSTNAME.EXAMPLE.COM'
  keyTabPath               Kerberos KeyTab path
  remoteKeyTabPath         Kerberos KeyTab path on Hadoop node
Command: kms tokenBucket kmsKeyId project

  tokenBucket              GCS Bucket used for token storage
  kmsKeyId                 KMS key id 'projects/*/locations/*/keyRings/*/cryptoKeys/*'
  project                  Project ID
  --help                   prints this usage text
GInit stores a Google IAM Access Token in Hadoop Configuration or GCS with KMS envelope encryption and writes a Hadoop Configuration XML to configure the GCS connector to use the stored access token for user credentials
```


## Pre-requisites

The GCS Connector jar must be installed on all Hadoop nodes.
SBT is required to build the jar

## Building

To build `ginit.jar` run `sbt assembly`


## Disclaimer

This is not an official Google project.
